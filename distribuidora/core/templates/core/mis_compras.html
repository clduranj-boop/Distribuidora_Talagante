{% extends 'core/base.html' %}
{% load static %}
{% block content %}
    <div class="mis-compras container mt-3">
        <h1>Mis Compras</h1>

        
        <div class="filters">
            <form method="get" class="d-flex gap-2">
                <select name="estado" class="form-select" onchange="this.form.submit()">
                    <option value="">Todos los estados</option>
                    {% for value, label in ESTADOS %}
                        <option value="{{ value }}" {% if request.GET.estado == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Buscar por ID de orden">
                <button type="submit" class="btn">Buscar</button>
            </form>
        </div>

        {% if ordenes %}
            {% for orden in ordenes %}
                <article class="order-card">
                    <div class="order-head">
                        <h2>Orden #{{ orden.id }}</h2>
                        <span class="badge {% if orden.estado == 'pendiente' %}badge-pend{% elif orden.estado == 'confirmado' %}badge-pago{% elif orden.estado == 'despacho' %}badge-envi{% else %}badge-entr{% endif %}">
                            {{ orden.get_estado_display }}
                        </span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in orden.itemorden_set.all %}
                                <tr>
                                    <td>{{ item.producto.nombre }}</td>
                                    <td>{{ item.cantidad }}</td>
                                    <td>${{ item.subtotal|floatformat:2 }}</td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="3">No hay ítems en esta orden</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2">Total</td>
                                <td>${{ orden.total|floatformat:2 }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </article>
            {% endfor %}

            
            {% if ordenes.has_other_pages %}
                <nav aria-label="Paginación" class="mt-3">
                    <ul class="pagination">
                        {% if ordenes.has_previous %}
                            <li class="page-item"><a class="page-link" href="?page={{ ordenes.previous_page_number }}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Anterior</a></li>
                        {% endif %}
                        <li class="page-item active"><span class="page-link">Página {{ ordenes.number }} de {{ ordenes.paginator.num_pages }}</span></li>
                        {% if ordenes.has_next %}
                            <li class="page-item"><a class="page-link" href="?page={{ ordenes.next_page_number }}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Siguiente</a></li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <p>No tienes compras registradas. <a href="{% url 'catalogo' %}" class="btn btn-primary">Ir al catálogo</a></p>
        {% endif %}
    </div>
{% endblock %}