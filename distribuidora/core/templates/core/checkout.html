{% extends "core/base.html" %}
{% load static %}
{% block title %}Checkout — Distribuidora{% endblock %}

{% block content %}
<div class="checkout">
  <main class="container">
    <div class="checkout-grid">
      <section class="panel">
        <h3>Resumen del pedido</h3>
        {% if items %}
          <table>
            <thead>
              <tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody>
              {% for it in items %}
                <tr>
                  <td>{{ it.producto.nombre }}</td>
                  <td>{{ it.cantidad }}</td>
                  <td>${{ it.producto.precio }}</td>
                  <td>${{ it.subtotal }}</td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>${{ total }}</strong></td></tr>
            </tfoot>
          </table>
        {% else %}
          <p>No hay ítems en el carrito.</p>
        {% endif %}
      </section>

      <aside class="panel">
        <h3>Pago</h3>
        <form id="pago-form">
          {% csrf_token %}
          <div class="mt-2">
            <label for="metodo_pago">Método de pago</label>
            <select id="metodo_pago" name="metodo_pago">
              <option value="transferencia" selected>Transferencia bancaria</option>
              <option value="efectivo">Efectivo (retiro)</option>
            </select>
          </div>

          <input type="hidden" id="total" name="total" value="{{ total }}">

          <div class="mt-3">
            <button class="btn btn-primary" type="submit">Finalizar pedido</button>
          </div>

          <p class="mt-2" id="pago-msg" style="display:none;"></p>
        </form>
      </aside>
    </div>
  </main>
</div>

{% block extra_script %}
<script>
(function(){
  const form = document.getElementById('pago-form');
  const msg  = document.getElementById('pago-msg');
  function getCSRF(){const i=form.querySelector('input[name="csrfmiddlewaretoken"]');return i?i.value:'';}

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.style.display='block'; msg.textContent='Procesando pedido…';
    try{
      const res = await fetch("{% url 'crear_orden' %}", {
        method:'POST',
        headers:{'X-CSRFToken':getCSRF(), 'Accept':'application/json'},
        body:new URLSearchParams({metodo_pago:form.metodo_pago.value, total:document.getElementById('total').value})
      });
      const data = await res.json();
      if(res.ok && data.whatsapp_link){ msg.textContent='Redirigiendo a WhatsApp…'; window.location.href=data.whatsapp_link; }
      else{ msg.textContent=data.error || 'No se pudo crear la orden.'; }
    }catch{ msg.textContent='Error de red.'; }
  });
})();
</script>
{% endblock %}
{% endblock %}