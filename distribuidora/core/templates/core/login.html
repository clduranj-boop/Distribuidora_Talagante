{% extends "core/base.html" %}
{% load static %}

{% block title %}Iniciar sesión o Registrarse — Distribuidora{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8 col-xl-7">
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-body p-4 p-md-5">
        <h1 class="h3 fw-bold mb-2">Iniciar Sesión o Registrarse</h1>
        <p class="text-muted mb-3">Accede para comprar y seguir tus pedidos. Si aún no tienes cuenta, regístrate en minutos.</p>

        
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link {% if not reg_error and request.GET.tab != 'register' %}active{% endif %}"
              data-bs-toggle="tab" data-bs-target="#pane-login" type="button" role="tab">
              Iniciar Sesión
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link {% if reg_error or request.GET.tab == 'register' %}active{% endif %}"
              data-bs-toggle="tab" data-bs-target="#pane-register" type="button" role="tab">
              Registrarse
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- LOGIN -->
          <div id="pane-login"
               class="tab-pane fade {% if not reg_error and request.GET.tab != 'register' %}show active{% endif %}"
               role="tabpanel">
            {% if error %}
              <div class="alert alert-danger mb-3">{{ error }}</div>
            {% endif %}
            <form method="post" action="{% url 'login' %}" class="needs-validation" novalidate>
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-control form-control-lg" name="username"
                       value="{{ request.POST.username }}" required>
                <div class="invalid-feedback">Ingresa tu usuario.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Contraseña</label>
                <div class="input-group input-group-lg">
                  <input type="password" class="form-control" name="password" id="loginPass" required>
                  <button class="btn btn-outline-secondary" type="button" data-toggle-pass="#loginPass">👁</button>
                  <div class="invalid-feedback">Ingresa tu contraseña.</div>
                </div>
              </div>
              <div class="d-grid d-sm-flex gap-2">
                <button class="btn btn-primary btn-lg" type="submit">Iniciar Sesión</button>
              </div>
            </form>
          </div>

          <!-- REGISTRO -->
          <div id="pane-register"
               class="tab-pane fade {% if reg_error or request.GET.tab == 'register' %}show active{% endif %}"
               role="tabpanel">
            {% if reg_error %}
              <div class="alert alert-danger mb-3">{{ reg_error }}</div>
            {% endif %}
            <form method="post" action="{% url 'register' %}" class="needs-validation" novalidate>
              {% csrf_token %}
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Usuario</label>
                  <input type="text" class="form-control form-control-lg" name="username"
                         value="{{ request.POST.username }}" required>
                  <div class="invalid-feedback">Elige un usuario.</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Contraseña</label>
                  <div class="input-group input-group-lg">
                    <input type="password" class="form-control" name="password" id="regPass" required>
                    <button class="btn btn-outline-secondary" type="button" data-toggle-pass="#regPass">👁</button>
                    <div class="invalid-feedback">Crea una contraseña.</div>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Nombre completo</label>
                  <input type="text" class="form-control form-control-lg" name="nombre_completo"
                         value="{{ request.POST.nombre_completo }}" required>
                  <div class="invalid-feedback">Ingresa tu nombre completo.</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">RUT <span class="text-muted">(12.345.678-9)</span></label>
                  <input type="text" class="form-control form-control-lg" name="rut"
                         value="{{ request.POST.rut }}" required>
                  <div class="invalid-feedback">Ingresa un RUT válido.</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Teléfono (opcional)</label>
                  <input type="tel" class="form-control form-control-lg" name="telefono"
                         value="{{ request.POST.telefono }}">
                </div>
                <div class="col-12 d-grid d-sm-flex gap-2">
                  <button class="btn btn-primary btn-lg" type="submit">Registrarse</button>
                </div>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // Mostrar/ocultar contraseña (👁/🙈)
  document.querySelectorAll('[data-toggle-pass]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input = document.querySelector(btn.getAttribute('data-toggle-pass'));
      if(!input) return;
      const show = input.type === 'password';
      input.type = show ? 'text' : 'password';
      btn.textContent = show ? '🙈' : '👁';
    });
  });

  // Validación Bootstrap opcional
  (function(){
    const forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault(); event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();
</script>
{% endblock %}
