{% extends "core/base.html" %}
{% load static humanize %}
{% load mathfilters %}
{% block title %}Mi Carrito — Distribuidora Talagante{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="carrito py-5">
  <div class="container">
    <h2 class="text-center mb-5 fw-bold text-primary">Mi Carrito de Compras</h2>

    {% if mensaje %}
      <div class="text-center py-5">
        <h3 class="text-muted">{{ mensaje }}</h3>
        <a href="{% url 'catalogo' %}" class="btn btn-lg btn-primary mt-4">Ir al Catálogo</a>
      </div>
    {% else %}
      <div class="cart-wrap">
        <div class="cart-table mb-5">
          <table class="table align-middle">
            <thead class="text-muted small">
              <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
                <tr>
                  <td class="prod-cell d-flex align-items-center gap-3">
                    {% if it.producto.imagen %}
                      <img class="thumb rounded" src="{{ it.producto.imagen.url }}" style="width:70px; height:70px; object-fit:cover;">
                    {% else %}
                      <img class="thumb rounded" src="{% static 'core/img/placeholder.png' %}" style="width:70px; height:70px;">
                    {% endif %}
                    <div>
                      <div class="fw-bold">{{ it.producto.nombre }}</div>
                        <small class="text-success fw-bold">Stock Bodega: {{ it.producto.stock|floatformat:0 }}</small>
                          <br>
                            <small class="text-muted" style="font-size: 0.8rem;">
                           (Disponibles: {{ it.producto.stock|sub:it.cantidad }})
                            </small>
                    </div>
                  <td class="fw-bold">${{ it.producto.precio|floatformat:0|intcomma }}</td>

                  <!-- CANTIDAD ULTRA LINDA Y FUNCIONAL -->
                  <td>
                    <form action="{% url 'actualizar_cantidad_carrito' it.id %}" method="post" class="qty-form">
                      {% csrf_token %}
                      <div class="qty-input-group">
                        <button type="submit" name="accion" value="restar" 
                                class="qty-btn qty-btn-restar"
                                {% if it.cantidad <= 1 %}disabled{% endif %}>−</button>
                        
                        <input type="number" name="cantidad" value="{{ it.cantidad }}"
                               min="1" max="{{ it.producto.stock|floatformat:0 }}"
                               class="qty-input"
                               onchange="this.form.submit()"
                               onkeydown="if(event.key==='Enter'){this.form.submit()}">
                        
                        <button type="submit" name="accion" value="sumar" 
                                class="qty-btn qty-btn-sumar"
                                {% if it.cantidad >= it.producto.stock %}disabled{% endif %}>+</button>
                      </div>
                    </form>
                  </td>

                  <td class="fw-bold text-success fs-5">
                    ${{ it.cantidad|mul:it.producto.precio|floatformat:0|intcomma }}
                  </td>

                  <td>
                    <a href="{% url 'remove_from_carrito' it.id %}" class="btn-trash">
                      <i class="bi bi-trash3-fill"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- RESUMEN BONITO -->
        <aside class="summary p-4 bg-white rounded-4 shadow-lg" style="max-width: 380px; margin: 0 auto;">
          <h3 class="text-center mb-4">Resumen del Pedido</h3>
          <div class="d-flex justify-content-between mb-3"><span>Subtotal</span><strong>${{ total|floatformat:0|intcomma }}</strong></div>
          <div class="d-flex justify-content-between text-muted mb-4"><span>Envío</span><span>Por calcular</span></div>
          <hr>
          <div class="d-flex justify-content-between fs-4 fw-bold text-primary mb-4">
            <span>Total</span>
            <span>${{ total|floatformat:0|intcomma }}</span>
          </div>
          <a href="{% url 'checkout' %}" class="btn btn-success btn-lg w-100 shadow-lg">
            Proceder al Pago
          </a>
        </aside>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
