{% extends "core/base.html" %}
{% load static %}

{% block title %}Verificar Código - Distribuidora Talagante{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow">
        <div class="card-body text-center p-5">
          <i class="bi bi-shield-lock display-1 text-primary mb-4"></i>
          <h2 class="mb-4">Verifica tu cuenta</h2>
          <p class="text-muted mb-4">
            Te enviamos un código de 6 dígitos a:<br>
            <strong>{{ request.user.email }}</strong>
          </p>

          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags|default:'danger' }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          <form method="post" class="mt-4">
            {% csrf_token %}
            <div class="mb-4">
              <input type="text" name="codigo" maxlength="6" required autofocus
                     class="form-control form-control-lg text-center"
                     style="font-size: 2rem; letter-spacing: 10px;"
                     placeholder="000000"
                     value="{{ request.POST.codigo|default:'' }}"
                     oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,6)">
            </div>
            <button type="submit" class="btn btn-success btn-lg w-100 mb-3">
              Verificar Código
            </button>
          </form>

          <div class="mt-4 text-center">
  <button type="submit" form="formReenviar" class="btn btn-outline-primary" id="btnReenviar" disabled>
    <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
    Reenviar código <span id="contador">(60)</span>
  </button>
</div>

        <form method="post" action="{% url 'reenviar_codigo' %}" id="formReenviar" style="display:inline;">
          {% csrf_token %}
        </form>

        

          <div class="mt-3">
            <small class="text-muted">
              El código expira en 10 minutos<br>
              ¿No llegó? Revisa la carpeta de spam o 
              <a href="{% url 'register' %}">regístrate con otro correo</a>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
        let tiempo = 60;
        const btn = document.getElementById('btnReenviar');
        const contador = document.getElementById('contador');
        const spinner = document.getElementById('spinner');

        const countdown = setInterval(() => {
          tiempo--;
          contador.textContent = `(${tiempo})`;
          if (tiempo <= 0) {
            clearInterval(countdown);
            btn.disabled = false;
            btn.innerHTML = 'Reenviar código';
          }
        }, 1000);

        // Al hacer clic, mostrar spinner
        btn.addEventListener('click', () => {
          btn.disabled = true;
          spinner.classList.remove('d-none');
          btn.innerHTML = 'Enviando...';
        });
        </script>
{% endblock %}