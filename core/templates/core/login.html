{% extends "core/base.html" %}
{% load static %}

{% block title %}Iniciar sesión o Registrarse — Distribuidora Talagante{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8 col-xl-7">
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-body p-4 p-md-5">
        <h1 class="h3 fw-bold mb-2">Bienvenido</h1>
        <p class="text-muted mb-4">Inicia sesión o crea tu cuenta para comprar y seguir tus pedidos.</p>

        <!-- Pestañas -->
        <ul class="nav nav-tabs mb-4" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab != 'register' %}active{% endif %}"
                    data-bs-toggle="tab" data-bs-target="#pane-login" type="button">
              Iniciar Sesión
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.GET.tab == 'register' %}active{% endif %}"
                    data-bs-toggle="tab" data-bs-target="#pane-register" type="button">
              Crear Cuenta
            </button>
          </li>
        </ul>

        <div class="tab-content">

          <!-- ==================== INICIAR SESIÓN ==================== -->
          <div id="pane-login" class="tab-pane fade {% if request.GET.tab != 'register' %}show active{% endif %}" role="tabpanel">
            {% if error %}
              <div class="alert alert-danger alert-dismissible fade show mb-4">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endif %}

            <form method="post" action="{% url 'login' %}" class="needs-validation" novalidate>
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-control form-control-lg" name="username" value="{{ request.POST.username }}" required>
              </div>
              <div class="mb-4">
                <label class="form-label">Contraseña</label>
                <div class="input-group">
                  <input type="password" class="form-control form-control-lg" name="password" required>
                  <button type="button" class="btn btn-outline-secondary" onclick="togglePass(this)">Mostrar</button>
                </div>
              </div>
              <div class="d-grid">
                <button class="btn btn-primary btn-lg" type="submit">Iniciar Sesión</button>
              </div>
            </form>
          </div>

          <!-- ==================== REGISTRARSE ==================== -->
          <div id="pane-register" class="tab-pane fade {% if request.GET.tab == 'register' %}show active{% endif %}" role="tabpanel">

            <!-- MOSTRAR TODOS LOS MENSAJES (errores y éxito) -->
            {% if messages %}
              <div class="mb-4">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags|default:'danger' }} alert-dismissible fade show" role="alert">
                    <strong>
                      {% if message.tags == 'error' %}Error:{% elif message.tags == 'success' %}Éxito:{% else %}Atención:{% endif %}
                    </strong> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <form method="post" action="{% url 'register' %}" class="needs-validation" novalidate>
              {% csrf_token %}

              <div class="row g-3">
                <!-- Usuario y Email -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Usuario <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" name="username" value="{{ request.POST.username }}" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Correo electrónico <span class="text-danger">*</span></label>
                  <input type="email" class="form-control form-control-lg" name="email" value="{{ request.POST.email }}" required>
                </div>

                <!-- Nombres -->
                <div class="col-12 col-md-4">
                  <label class="form-label">Nombre(s) <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" name="nombre" value="{{ request.POST.nombre }}" required>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Apellido Paterno <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" name="apellido_paterno" value="{{ request.POST.apellido_paterno }}" required>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Apellido Materno</label>
                  <input type="text" class="form-control form-control-lg" name="apellido_materno" value="{{ request.POST.apellido_materno }}">
                </div>

                <!-- RUT y Teléfono -->
                <div class="col-12 col-md-6">
                  <label class="form-label">RUT <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" name="rut" 
                         placeholder="11.527.103-2" id="id_rut" required>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Teléfono (opcional)</label>
                  <input type="tel" class="form-control form-control-lg" name="telefono" value="{{ request.POST.telefono }}">
                </div>

                <!-- Contraseñas -->
                <div class="col-12 col-md-6">
                  <label class="form-label">Contraseña <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="password" class="form-control form-control-lg" name="password1" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePass(this)">Mostrar</button>
                  </div>
                  <small class="text-muted d-block mt-1">Mínimo 8 caracteres, 1 mayúscula y 1 número</small>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Repetir contraseña <span class="text-danger">*</span></label>
                  <input type="password" class="form-control form-control-lg" name="password2" required>
                </div>

                <!-- Feedback en vivo de contraseña -->
                <div class="col-12">
                  <div class="password-feedback mt-2 small"></div>
                </div>

                <!-- Botón -->
                <div class="col-12 d-grid mt-4">
                  <button class="btn btn-success btn-lg" type="submit">Crear mi cuenta</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_script %}
{% load static %}

<!--  Mantener pestaña activa incluso al recargar -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tab') === 'register') {
        const tab = new bootstrap.Tab(document.querySelector('[data-bs-target="#pane-register"]'));
        if (tab) tab.show();
    }
});
</script>

<!-- 2. Validaciones modulares (si usas el archivo register.js) -->
<script type="module">
  import { initRegisterValidation } from {% static 'core/js/validators/register.js' %};
  
  const registerTab = document.querySelector('[data-bs-target="#pane-register"]');
  if (registerTab) {
    registerTab.addEventListener('shown.bs.tab', () => initRegisterValidation());
  }
  if (document.querySelector('#pane-register.show')) {
    initRegisterValidation();
  }
</script>

<!-- 3. Mostrar/Ocultar contraseña -->
<script>
  function togglePass(btn) {
    const input = btn.previousElementSibling;
    if (input.type === 'password') {
      input.type = 'text';
      btn.textContent = 'Ocultar';
    } else {
      input.type = 'password';
      btn.textContent = 'Mostrar';
    }
  }
</script>

<!-- 4. RUT: Mostrar bonito (con puntos) + Enviar limpio (11527103-2) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const rutInput = document.querySelector('input[name="rut"]');
    if (!rutInput) return;

    // Mientras escribe → mostrar con puntos (bonito)
    rutInput.addEventListener('input', function () {
        let valor = this.value.replace(/[^\dkK]/g, '').toUpperCase();
        if (valor.length > 1) {
            let dv = valor.slice(-1);
            let cuerpo = valor.slice(0, -1);
            cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            this.value = cuerpo + '-' + dv;
        }
    });

    // ANTES DE ENVIAR → quitar puntos y enviar limpio (11527103-2)
    rutInput.closest('form').addEventListener('submit', function () {
        let limpio = rutInput.value.replace(/[^\dkK]/gi, '').toUpperCase();
        if (limpio.length >= 9) {
            rutInput.value = limpio.slice(0, -1) + '-' + limpio.slice(-1);
        } else if (limpio.length >= 8) {
            rutInput.value = limpio;
        }
    });
});
</script>

<!-- 5. Validación de usuario (solo letras y números) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const usernameInput = document.querySelector('input[name="username"]');
    if (!usernameInput) return;

    usernameInput.addEventListener('input', function () {
        const value = this.value.trim();
        const isValid = /^[a-zA-Z0-9]+$/.test(value);
        this.classList.toggle('is-valid', isValid && value.length > 0);
        this.classList.toggle('is-invalid', value.length > 0 && !isValid);
    });
});
</script>

{% endblock %}
{% endblock %}