{% extends "core/base.html" %}
{% load humanize %}

{% block title %}Gestión de Estados - Panel Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="h3 mb-4 text-primary">
        Gestión de Estados de Pedidos
    </h1>

    <!-- Buscador y filtro -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <input type="text" name="q" class="form-control" placeholder="Buscar por ID, nombre o cliente..." value="{{ busqueda }}">
                </div>
                <div class="col-md-4">
                    <select name="estado" class="form-select">
                        <option value="">Todos los estados</option>
                        {% for valor, label in Orden.ESTADOS %}
                            <option value="{{ valor }}" {% if estado_filtro == valor %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary me-2">Buscar</button>
                    <a href="{% url 'gestion_estados' %}" class="btn btn-secondary">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#ID</th>
                        <th>Cliente</th>
                        <th>Total</th>
                        <th>Estado Actual</th>
                        <th>Cambiar Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in ordenes %}
                    <tr>
                        <td><strong>#{{ o.id }}</strong></td>
                        <td>
                            <div>{{ o.usuario.username }}</div>
                            <small class="text-muted">{{ o.usuario.perfil.nombre_completo|default:"Sin nombre" }}</small>
                        </td>
                        <td class="text-success fw-bold">${{ o.total|intcomma }}</td>
                        <td>
                            <span class="badge bg-info fs-6">{{ o.get_estado_display }}</span>
                        </td>
                        <td>
                            <form method="post" class="d-inline cambio-estado-form" data-orden-id="{{ o.id }}">
                                {% csrf_token %}
                                <select name="estado" class="form-select form-select-sm">
                                    {% for valor, label in estados_choices %}
                                        <option value="{{ valor }}" {% if o.estado == valor %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>
                            <a href="{% url 'orden_detail' o.id %}" class="btn btn-sm btn-primary">Ver</a>
                            <a href="{{ o.get_whatsapp_link }}" target="_blank" class="btn btn-sm btn-success">WhatsApp</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <h4>No hay órdenes para mostrar</h4>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.cambio-estado-form select').forEach(select => {
    select.addEventListener('change', function() {
        if (!confirm('¿Cambiar estado de la orden #' + this.closest('form').dataset.ordenId + '?')) return;

        const form = this.closest('form');
        const formData = new FormData(form);
        formData.append('orden_id', form.dataset.ordenId);

        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const badge = form.closest('tr').querySelector('.badge');
                badge.textContent = data.nuevo_estado;
                badge.className = 'badge bg-success fs-6';
                alert('¡Estado actualizado y correo enviado al cliente!');
            } else {
                alert('Error al actualizar');
            }
        });
    });
});
</script>
{% endblock %}